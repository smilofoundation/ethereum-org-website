<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IBFT Consensus Overview | Smilo</title>
    <meta name="description" content="">
    <meta/ name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,maximum-scale=1"></meta/>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="smilo.foundation">
  <meta property="og:url" content="https://smilo.foundation">
  <meta property="og:image" content="https://smilo.foundation/og-image.png">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:site" content="@smiloplatform">
  <meta property="twitter:creator" content="@smiloplatform">
  <meta property="twitter:image" content="https://smilo.foundation/og-image-twitter.png">
    <link rel="preload" href="/assets/css/0.styles.77284882.css" as="style"><link rel="preload" href="/assets/js/app.1c5a03b7.js" as="script"><link rel="preload" href="/assets/js/3.030594d3.js" as="script"><link rel="preload" href="/assets/js/19.a08feb93.js" as="script"><link rel="prefetch" href="/assets/js/10.6e3e9273.js"><link rel="prefetch" href="/assets/js/100.54f82e92.js"><link rel="prefetch" href="/assets/js/101.0d7e4727.js"><link rel="prefetch" href="/assets/js/102.e09888c2.js"><link rel="prefetch" href="/assets/js/103.12c4db4a.js"><link rel="prefetch" href="/assets/js/104.917d85b3.js"><link rel="prefetch" href="/assets/js/105.2c8a97c2.js"><link rel="prefetch" href="/assets/js/106.137429f1.js"><link rel="prefetch" href="/assets/js/107.3dd3c2b0.js"><link rel="prefetch" href="/assets/js/108.ae0d09f1.js"><link rel="prefetch" href="/assets/js/109.05199ced.js"><link rel="prefetch" href="/assets/js/11.f4ce1d53.js"><link rel="prefetch" href="/assets/js/110.72857918.js"><link rel="prefetch" href="/assets/js/111.5c9c5ec1.js"><link rel="prefetch" href="/assets/js/112.4b4aa971.js"><link rel="prefetch" href="/assets/js/113.467b4f39.js"><link rel="prefetch" href="/assets/js/114.e37bc94a.js"><link rel="prefetch" href="/assets/js/115.e2033c8c.js"><link rel="prefetch" href="/assets/js/116.0f3bb3de.js"><link rel="prefetch" href="/assets/js/117.97f66c3d.js"><link rel="prefetch" href="/assets/js/118.61cc124c.js"><link rel="prefetch" href="/assets/js/119.70620c50.js"><link rel="prefetch" href="/assets/js/12.068e04f8.js"><link rel="prefetch" href="/assets/js/120.43a34ff2.js"><link rel="prefetch" href="/assets/js/121.80ec60ad.js"><link rel="prefetch" href="/assets/js/122.f38284d1.js"><link rel="prefetch" href="/assets/js/123.1dc518a3.js"><link rel="prefetch" href="/assets/js/124.5765d2e5.js"><link rel="prefetch" href="/assets/js/125.c734c24f.js"><link rel="prefetch" href="/assets/js/126.79b78b84.js"><link rel="prefetch" href="/assets/js/127.25ff388a.js"><link rel="prefetch" href="/assets/js/128.1496ac92.js"><link rel="prefetch" href="/assets/js/129.4e04e6cc.js"><link rel="prefetch" href="/assets/js/13.bda859e5.js"><link rel="prefetch" href="/assets/js/130.f107b701.js"><link rel="prefetch" href="/assets/js/131.08b783f2.js"><link rel="prefetch" href="/assets/js/14.2a400896.js"><link rel="prefetch" href="/assets/js/15.295d62fc.js"><link rel="prefetch" href="/assets/js/16.652a89b0.js"><link rel="prefetch" href="/assets/js/17.3be5eda0.js"><link rel="prefetch" href="/assets/js/18.32454e69.js"><link rel="prefetch" href="/assets/js/2.4b1d4bf3.js"><link rel="prefetch" href="/assets/js/20.34e166bb.js"><link rel="prefetch" href="/assets/js/21.1d2ef408.js"><link rel="prefetch" href="/assets/js/22.2a6cd144.js"><link rel="prefetch" href="/assets/js/23.5adcd431.js"><link rel="prefetch" href="/assets/js/24.9bccf9d1.js"><link rel="prefetch" href="/assets/js/25.d8fd4102.js"><link rel="prefetch" href="/assets/js/26.40635db2.js"><link rel="prefetch" href="/assets/js/27.9a5f2d44.js"><link rel="prefetch" href="/assets/js/28.2d385e7d.js"><link rel="prefetch" href="/assets/js/29.da082ef6.js"><link rel="prefetch" href="/assets/js/30.73aec03b.js"><link rel="prefetch" href="/assets/js/31.f86eee3a.js"><link rel="prefetch" href="/assets/js/32.46e321e1.js"><link rel="prefetch" href="/assets/js/33.e63e33f3.js"><link rel="prefetch" href="/assets/js/34.1d8e044f.js"><link rel="prefetch" href="/assets/js/35.af094489.js"><link rel="prefetch" href="/assets/js/36.fd9805c3.js"><link rel="prefetch" href="/assets/js/37.7a620d2c.js"><link rel="prefetch" href="/assets/js/38.eac140f8.js"><link rel="prefetch" href="/assets/js/39.3a26a316.js"><link rel="prefetch" href="/assets/js/4.9ea4066c.js"><link rel="prefetch" href="/assets/js/40.c0974fab.js"><link rel="prefetch" href="/assets/js/41.62cd62ac.js"><link rel="prefetch" href="/assets/js/42.20944c6a.js"><link rel="prefetch" href="/assets/js/43.e88d32e5.js"><link rel="prefetch" href="/assets/js/44.9d1312b3.js"><link rel="prefetch" href="/assets/js/45.e68f16da.js"><link rel="prefetch" href="/assets/js/46.20ba1095.js"><link rel="prefetch" href="/assets/js/47.37709ee2.js"><link rel="prefetch" href="/assets/js/48.d96ab555.js"><link rel="prefetch" href="/assets/js/49.59fb3a5d.js"><link rel="prefetch" href="/assets/js/5.9c269fae.js"><link rel="prefetch" href="/assets/js/50.dd2320c1.js"><link rel="prefetch" href="/assets/js/51.99326924.js"><link rel="prefetch" href="/assets/js/52.2f8bdcae.js"><link rel="prefetch" href="/assets/js/53.b65c9b3b.js"><link rel="prefetch" href="/assets/js/54.8f1c1e12.js"><link rel="prefetch" href="/assets/js/55.abe1f4b6.js"><link rel="prefetch" href="/assets/js/56.1b79c9a4.js"><link rel="prefetch" href="/assets/js/57.97bf7386.js"><link rel="prefetch" href="/assets/js/58.eab2d512.js"><link rel="prefetch" href="/assets/js/59.dc4064e5.js"><link rel="prefetch" href="/assets/js/6.530b08db.js"><link rel="prefetch" href="/assets/js/60.6c9bd626.js"><link rel="prefetch" href="/assets/js/61.7d3b7f84.js"><link rel="prefetch" href="/assets/js/62.0a97fcb0.js"><link rel="prefetch" href="/assets/js/63.15d50454.js"><link rel="prefetch" href="/assets/js/64.9fe77f7e.js"><link rel="prefetch" href="/assets/js/65.d0f3dc77.js"><link rel="prefetch" href="/assets/js/66.75f6f323.js"><link rel="prefetch" href="/assets/js/67.997e57cb.js"><link rel="prefetch" href="/assets/js/68.c627100e.js"><link rel="prefetch" href="/assets/js/69.1757e396.js"><link rel="prefetch" href="/assets/js/7.393450db.js"><link rel="prefetch" href="/assets/js/70.4fead485.js"><link rel="prefetch" href="/assets/js/71.9d601385.js"><link rel="prefetch" href="/assets/js/72.df61f604.js"><link rel="prefetch" href="/assets/js/73.1ba6adec.js"><link rel="prefetch" href="/assets/js/74.dae5c946.js"><link rel="prefetch" href="/assets/js/75.ed1750af.js"><link rel="prefetch" href="/assets/js/76.23271b77.js"><link rel="prefetch" href="/assets/js/77.8f47131e.js"><link rel="prefetch" href="/assets/js/78.49a99228.js"><link rel="prefetch" href="/assets/js/79.66c05d68.js"><link rel="prefetch" href="/assets/js/8.afe1cb0f.js"><link rel="prefetch" href="/assets/js/80.14ebffb1.js"><link rel="prefetch" href="/assets/js/81.f69d7b2b.js"><link rel="prefetch" href="/assets/js/82.79ac4d75.js"><link rel="prefetch" href="/assets/js/83.5551e100.js"><link rel="prefetch" href="/assets/js/84.9d9dd0e5.js"><link rel="prefetch" href="/assets/js/85.41e7de0a.js"><link rel="prefetch" href="/assets/js/86.5ada016f.js"><link rel="prefetch" href="/assets/js/87.5cf495b9.js"><link rel="prefetch" href="/assets/js/88.2ac2cd3b.js"><link rel="prefetch" href="/assets/js/89.7816c1f3.js"><link rel="prefetch" href="/assets/js/9.828672e1.js"><link rel="prefetch" href="/assets/js/90.c5ba453d.js"><link rel="prefetch" href="/assets/js/91.257808f3.js"><link rel="prefetch" href="/assets/js/92.0425b893.js"><link rel="prefetch" href="/assets/js/93.caafd925.js"><link rel="prefetch" href="/assets/js/94.190ec2a0.js"><link rel="prefetch" href="/assets/js/95.3fbee9bb.js"><link rel="prefetch" href="/assets/js/96.ced1da5b.js"><link rel="prefetch" href="/assets/js/97.b518b74f.js"><link rel="prefetch" href="/assets/js/98.09a32c0b.js"><link rel="prefetch" href="/assets/js/99.503bd021.js">
    <link rel="stylesheet" href="/assets/css/0.styles.77284882.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="wrapper" data-v-586e078c><header class="header-right flex" data-v-6f1c53dc data-v-586e078c><div class="flex" data-v-6f1c53dc><div class="sidebar-button" data-v-6f1c53dc><svg width="25px" height="20px" viewBox="0 0 25 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="icon"><title>Hamburger menu button</title> <g transform="translate(-22.000000, -2.000000)"><g transform="translate(22.000000, 2.545974)"><path d="M24.7714844,0.5 L0,0.5"></path> <path d="M24.7714844,9.72701303 L0,9.72701303"></path> <path d="M24.7714844,18.9540261 L0,18.9540261"></path></g></g></svg> <a href="/" class="home-link router-link-active"><span class="site-name">Smilo</span></a></div> <a href="/" class="router-link-active" data-v-6f1c53dc><img src="/assets/img/ethereum-logo-wireframe.8c2f2894.png" alt="Smilo Logo" class="header-logo sm-hide" data-v-6f1c53dc></a> <nav class="nav-links sm-hide" data-v-6f1c53dc><ul class="nav-ul"><li class="nav-item"><a href="/" class="nav-link">Smilo</a></li><li class="nav-item"><a href="/beginners/" class="nav-link">Beginners</a></li><li class="nav-item"><a href="/use/" class="nav-link">Use</a></li><li class="nav-item"><a href="/learn/" class="nav-link">Learn</a></li><li class="nav-item"><a href="/developers/" class="nav-link">Developers</a></li> <!----></ul></nav></div> <div class="menu inline flex flex-center" data-v-6f1c53dc><div class="search-box" data-v-6f1c53dc><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="https://github.com/smilofoundation/smilo-foundation-website" target="_blank" title="Fork This Page (Github)" data-v-6f1c53dc><img alt="Github" src="/assets/img/icon-github.3720c649.svg" class="hide-dark" data-v-6f1c53dc> <img alt="Github" src="/assets/img/icon-github-white.e05d488b.svg" class="show-dark" data-v-6f1c53dc></a> <span class="pointer view-mode" data-v-6f1c53dc><img alt="Switch to Dark Mode" src="/assets/img/icon-sun.f0087fa4.svg" class="hide-dark" data-v-6f1c53dc> <img alt="Switch to Light Mode" src="/assets/img/icon-moon.0d522939.svg" class="show-dark" data-v-6f1c53dc></span> <div class="dropdown-wrapper sm-hide" data-v-6f1c53dc><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Consensus/sport/sport.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/ko/" class="nav-link">Korean</a></li></ul></div></div></header> <!----> <main class="page" data-v-586e078c><div class="content__default" data-v-586e078c><h1 id="ibft-consensus-overview"><a href="#ibft-consensus-overview" aria-hidden="true" class="header-anchor">↳</a> IBFT Consensus Overview</h1> <h2 id="introduction"><a href="#introduction" aria-hidden="true" class="header-anchor">↳</a> Introduction</h2> <p>Istanbul Byzantine Fault Tolerant (IBFT) consensus is inspired by Castro-Liskov 99 <a href="http://pmg.csail.mit.edu/papers/osdi99.pdf" target="_blank" rel="noopener noreferrer">paper<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. IBFT inherits from the original PBFT by using a 3-phase consensus, <code>PRE-PREPARE</code>, <code>PREPARE</code> and <code>COMMIT</code>. The system can tolerate at most <code>F</code> faulty nodes in a <code>N</code> validator network, where <code>N = 3F + 1</code>.</p> <h2 id="implementation"><a href="#implementation" aria-hidden="true" class="header-anchor">↳</a> Implementation</h2> <h3 id="terminology"><a href="#terminology" aria-hidden="true" class="header-anchor">↳</a> Terminology</h3> <ul><li><code>Validator</code>: Block validation participant.</li> <li><code>Proposer</code>: A block validation participant that is chosen to propose block in a consensus round.</li> <li><code>Round</code>: Consensus round. A round starts with the proposer creating a block proposal and ends with a block commitment or round change.</li> <li><code>Proposal</code>: New block generation proposal which is undergoing consensus processing.</li> <li><code>Sequence</code>: Sequence number of a proposal. A sequence number should be greater than all previous sequence numbers. Currently each proposed block height is its associated sequence number.</li> <li><code>Backlog</code>: The storage to keep future consensus messages.</li> <li><code>Round state</code>: Consensus messages of a specific sequence and round, including pre-prepare message, prepare message, and commit message.</li> <li><code>Consensus proof</code>: The commitment signatures of a block that can prove the block has gone through the consensus process.</li> <li><code>Snapshot</code>: The validator voting state from last epoch.</li></ul> <h3 id="consensus"><a href="#consensus" aria-hidden="true" class="header-anchor">↳</a> Consensus</h3> <p>Istanbul BFT Consensus protocol begins at Round <code>0</code> with the validators picking a proposer from themselves in a round robin fashion. The proposer will then propose a new block proposal and broadcast it along with the <code>PRE-PREPARE</code> message. Upon receiving the <code>PRE-PREPARE</code> message from the proposer, other validators validate the incoming proposal and enter the state of <code>PRE-PREPARED</code> and broadcast <code>PREPARE</code> message. This step is to make sure all validators are working on the same sequence and on the same round. When <code>ceil(2N/3)</code> of <code>PREPARE</code> messages is received by the validator from other validators, the validator switches to the state of <code>PREPARED</code> and broadcasts <code>COMMIT</code> message. This step is to inform other validators that it accepts the proposed block and is going to insert the block to the chain. Lastly, validators wait for <code>ceil(2N/3)</code> of <code>COMMIT</code> messages to enter <code>COMMITTED</code> state and then append the block to the chain.</p> <p>Blocks in Istanbul BFT protocol are final, which means that there are no forks and any valid block must be somewhere in the main chain. To prevent a faulty node from generating a totally different chain from the main chain, each validator appends <code>ceil(2N/3)</code> of received <code>COMMIT</code> signatures to <code>extraData</code> field in the header before inserting it into the chain. Thus all blocks are self-verifiable. However, the dynamic <code>extraData</code> would cause an issue on block hash calculation. Since the same block from different validators can have different set of <code>COMMIT</code> signatures, the same block can have different block hashes as well. To solve this, we calculate the block hash by excluding the <code>COMMIT</code> signatures part. Therefore, we can still keep the block/block hash consistency as well as put the consensus proof in the block header.</p> <h4 id="consensus-states"><a href="#consensus-states" aria-hidden="true" class="header-anchor">↳</a> Consensus States</h4> <p>Istanbul BFT is a state machine replication algorithm. Each validator maintains a state machine replica in order to reach block consensus. Various states in IBFT consensus are,</p> <ul><li><code>NEW ROUND</code>: Proposer to send new block proposal. Validators wait for <code>PRE-PREPARE</code> message.</li> <li><code>PRE-PREPARED</code>: A validator has received <code>PRE-PREPARE</code> message and broadcasts <code>PREPARE</code> message. Then it waits for <code>ceil(2N/3)</code> of <code>PREPARE</code> or <code>COMMIT</code> messages.</li> <li><code>PREPARED</code>: A validator has received <code>ceil(2N/3)</code> of <code>PREPARE</code> messages and broadcasts <code>COMMIT</code> messages. Then it waits for <code>ceil(2N/3)</code> of <code>COMMIT</code> messages.</li> <li><code>COMMITTED</code>: A validator has received <code>ceil(2N/3)</code> of <code>COMMIT</code> messages and is able to insert the proposed block into the blockchain.</li> <li><code>FINAL COMMITTED</code>: A new block is successfully inserted into the blockchain and the validator is ready for the next round.</li> <li><code>ROUND CHANGE</code>: A validator is waiting for <code>ceil(2N/3)</code> of <code>ROUND CHANGE</code> messages on the same proposed round number.</li></ul> <p><strong>State Transitions</strong>:
<img src="images/IBFTStateTransition.png" alt="State Transitions"></p> <ul><li><code>NEW ROUND</code> -&gt; <code>PRE-PREPARED</code>:
<ul><li><strong>Proposer</strong> collects transactions from txpool.</li> <li><strong>Proposer</strong> generates a block proposal and broadcasts it to validators. It then enters the <code>PRE-PREPARED</code> state.</li> <li>Each <strong>validator</strong> enters <code>PRE-PREPARED</code> upon receiving the <code>PRE-PREPARE</code> message with the following conditions:
<ul><li>Block proposal is from the valid proposer.</li> <li>Block header is valid.</li> <li>Block proposal's sequence and round match the <strong>validator</strong>'s state.</li></ul></li> <li><strong>Validator</strong> broadcasts <code>PREPARE</code> message to other validators.</li></ul></li> <li><code>PRE-PREPARED</code> -&gt; <code>PREPARED</code>:
<ul><li>Validator receives <code>ceil(2N/3)</code> of valid <code>PREPARE</code> messages to enter <code>PREPARED</code> state. Valid messages conform to the following conditions:
<ul><li>Matched sequence and round.</li> <li>Matched block hash.</li> <li>Messages are from known validators.</li></ul></li> <li>Validator broadcasts <code>COMMIT</code> message upon entering <code>PREPARED</code> state.</li></ul></li> <li><code>PREPARED</code> -&gt; <code>COMMITTED</code>:
<ul><li><strong>Validator</strong> receives <code>ceil(2N/3)</code> of valid <code>COMMIT</code> messages to enter <code>COMMITTED</code> state. Valid messages conform to the following conditions:
<ul><li>Matched sequence and round.</li> <li>Matched block hash.</li> <li>Messages are from known validators.</li></ul></li></ul></li> <li><code>COMMITTED</code> -&gt; <code>FINAL COMMITTED</code>:
<ul><li><strong>Validator</strong> appends <code>ceil(2N/3)</code> commitment signatures to <code>extraData</code> and tries to insert the block into the blockchain.</li> <li><strong>Validator</strong> enters <code>FINAL COMMITTED</code> state when insertion succeeds.</li></ul></li> <li><code>FINAL COMMITTED</code> -&gt; <code>NEW ROUND</code>:
<ul><li><strong>Validators</strong> pick a new <strong>proposer</strong> and begin a new round timer.</li></ul></li></ul> <h4 id="round-change-flow"><a href="#round-change-flow" aria-hidden="true" class="header-anchor">↳</a> Round change flow</h4> <ul><li>There are three conditions that would trigger <code>ROUND CHANGE</code>:
<ul><li>Round change timer expires.</li> <li>Invalid <code>PREPREPARE</code> message.</li> <li>Block insertion fails.</li></ul></li> <li>When a validator notices that one of the above conditions applies, it broadcasts a <code>ROUND CHANGE</code> message along with the proposed round number and waits for <code>ROUND CHANGE</code> messages from other validators. The proposed round number is selected based on following condition:
<ul><li>If the validator has received <code>ROUND CHANGE</code> messages from its peers, it picks the largest round number which has <code>F + 1</code> of <code>ROUND CHANGE</code> messages.</li> <li>Otherwise, it picks <code>1 + current round number</code> as the proposed round number.</li></ul></li> <li>Whenever a validator receives <code>F + 1</code> of <code>ROUND CHANGE</code> messages on the same proposed round number, it compares the received one with its own. If the received is larger, the validator broadcasts <code>ROUND CHANGE</code> message again with the received number.</li> <li>Upon receiving <code>ceil(2N/3)</code> of <code>ROUND CHANGE</code> messages on the same proposed round number, the <strong>validator</strong> exits the round change loop, calculates the new <strong>proposer</strong>, and then enters <code>NEW ROUND</code> state.</li> <li>Another condition that a validator jumps out of round change loop is when it receives verified block(s) through peer synchronization.</li></ul> <h4 id="proposer-selection"><a href="#proposer-selection" aria-hidden="true" class="header-anchor">↳</a> Proposer selection</h4> <p>Currently we support two policies: <strong>round robin</strong> and <strong>sticky proposer</strong>.</p> <ul><li>Round robin: Round robin is the default proposer selection policy. In this setting proposer will change in every block and round change.</li> <li>Sticky proposer: in a sticky proposer setting, proposer will change only when a round change happens.</li></ul> <h4 id="validator-list-voting"><a href="#validator-list-voting" aria-hidden="true" class="header-anchor">↳</a> Validator list voting</h4> <p>Istanbul BFT uses a similar validator voting mechanism as Clique and copies most of the content from Clique <a href="https://github.com/ethereum/EIPs/issues/225" target="_blank" rel="noopener noreferrer">EIP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Every epoch transaction resets the validator voting, meaning any pending votes for adding/removing a validator are reset.</p> <p>For all transactions blocks:</p> <ul><li>Proposer can cast one vote to propose a change to the validators list.</li> <li>Only the latest proposal per target beneficiary is kept from a single validator.</li> <li>Votes are tallied live as the chain progresses (concurrent proposals allowed).</li> <li>Proposals reaching majority consensus <code>VALIDATOR_LIMIT</code> come into effect immediately.</li> <li>Invalid proposals are not to be penalized for client implementation simplicity.</li> <li>A proposal coming into effect entails discarding all pending votes for that proposal (both for and against) and starts with a clean slate.</li></ul> <h4 id="future-message-and-backlog"><a href="#future-message-and-backlog" aria-hidden="true" class="header-anchor">↳</a> Future message and backlog</h4> <p>In an asynchronous network environment, one may receive future messages which cannot be processed in the current state. For example, a validator can receive <code>COMMIT</code> messages on <code>NEW ROUND</code>. We call this kind of message a &quot;future message.&quot; When a validator receives a future message, it will put the message into its <strong>backlog</strong> and try to process later whenever possible.</p> <h4 id="constants"><a href="#constants" aria-hidden="true" class="header-anchor">↳</a> Constants</h4> <p>Istanbul BFT define the following constants</p> <ul><li><code>EPOCH_LENGTH</code>: Default: 30000 blocks. Number of blocks after which to checkpoint and reset the pending votes.</li> <li><code>REQUEST_TIMEOUT</code>: Timeout for each consensus round before firing a round change in millisecond.</li> <li><code>BLOCK_PERIOD</code>: Minimum timestamp difference in seconds between two consecutive blocks.</li> <li><code>PROPOSER_POLICY</code>: Proposer selection policy, defaults to round robin.</li> <li><code>ISTANBUL_DIGEST</code>: Fixed magic number <code>0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365</code> of <code>mixDigest</code> in block header for Istanbul block identification.</li> <li><code>DEFAULT_DIFFICULTY</code>: Default block difficulty, which is set to <code>0x0000000000000001</code>.</li> <li><code>EXTRA_VANITY</code>: Fixed number of extra-data prefix bytes reserved for proposer vanity.
<ul><li>Suggested <code>32</code> bytes to retain the current extra-data allowance and/or use.</li></ul></li> <li><code>NONCE_AUTH</code>: Magic nonce number <code>0xffffffffffffffff</code> to vote on adding a validator.</li> <li><code>NONCE_DROP</code>: Magic nonce number <code>0x0000000000000000</code> to vote on removing a validator.</li> <li><code>UNCLE_HASH</code>: Always <code>Keccak256(RLP([]))</code> as uncles are meaningless outside of PoW.</li> <li><code>PREPREPARE_MSG_CODE</code>: Fixed number <code>0</code>. Message code for <code>PREPREPARE</code> message.</li> <li><code>PREPARE_MSG_CODE</code>: Fixed number <code>1</code>. Message code for <code>PREPARE</code> message.</li> <li><code>COMMIT_MSG_CODE</code>: Fixed number <code>2</code>. Message code for <code>COMMIT</code> message.</li> <li><code>ROUND_CHANGE_MSG_CODE</code>: Fixed number <code>3</code>. Message code for <code>ROUND CHANGE</code> message</li> <li><code>VALIDATOR_LIMIT</code>: Number of validators to pass an authorization or de-authorization proposal.
<ul><li>Must be <code>floor(N / 2) + 1</code> to enforce majority consensus on a chain.</li></ul></li></ul> <h4 id="block-header"><a href="#block-header" aria-hidden="true" class="header-anchor">↳</a> Block Header</h4> <p>Istanbul BFT does not add new block header fields. Instead, it follows Clique in repurposing the <code>ethash</code> header fields as follows:</p> <ul><li><p><code>nonce</code>: Proposer proposal regarding the account defined by the beneficiary field.</p> <ul><li>Should be <code>NONCE_DROP</code> to propose deauthorizing beneficiary as an existing validator.</li> <li>Should be <code>NONCE_AUTH</code> to propose authorizing beneficiary as a new validator.</li> <li><strong>Must</strong> be filled with zeroes, <code>NONCE_DROP</code> or <code>NONCE_AUTH</code></li></ul></li> <li><p><code>mixHash</code>: Fixed magic number <code>0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365</code> for Istanbul block identification.</p></li> <li><p><code>ommersHash</code>: Must be <code>UNCLE_HASH</code> as uncles are meaningless outside of PoW.</p></li> <li><p><code>timestamp</code>: Must be at least the parent timestamp + <code>BLOCK_PERIOD</code></p></li> <li><p><code>difficulty</code>: Must be filled with <code>0x0000000000000001</code>.</p></li> <li><p><code>extraData</code>: Combined field for signer vanity and RLP encoded Istanbul extra data, where Istanbul extra data contains validator list, proposer seal, and commit seals. Istanbul extra data is defined as follows:</p> <div class="language- extra-class"><pre class="language-text"><code>type IstanbulExtra struct {
        Validators    []common.Address 	//Validator addresses
        Seal          []byte	        //Proposer seal 65 bytes
        CommittedSeal [][]byte          //Committed seal, 65 * len(Validators) bytes
}
</code></pre></div><p>Thus the <code>extraData</code> would be in the form of <code>EXTRA_VANITY | ISTANBUL_EXTRA</code> where <code>|</code> represents a fixed index to separate vanity and Istanbul extra data (not an actual character for separator).</p> <ul><li>First <code>EXTRA_VANITY</code> bytes (fixed) may contain arbitrary proposer vanity data.</li> <li><code>ISTANBUL_EXTRA</code> bytes are the RLP encoded Istanbul extra data calculated from <code>RLP(IstanbulExtra)</code>, where <code>RLP()</code> is RLP encoding function, and <code>IstanbulExtra</code> is the Istanbul extra data.
<ul><li><code>Validators</code>: The list of validators, which <strong>must</strong> be sorted in ascending order.</li> <li><code>Seal</code>: The proposer's signature sealing of the header.</li> <li><code>CommittedSeal</code>: The list of commitment signature seals as consensus proof.</li></ul></li></ul></li></ul> <h4 id="block-hash-proposer-seal-and-committed-seals"><a href="#block-hash-proposer-seal-and-committed-seals" aria-hidden="true" class="header-anchor">↳</a> Block hash, proposer seal and committed seals</h4> <p>The Istanbul block hash calculation is different from the <code>ethash</code> block hash calculation due to the following reasons:</p> <ol><li>The proposer needs to put proposer's seal in <code>extraData</code> to prove the block is signed by the chosen proposer.</li> <li>The validators need to put <code>ceil(2N/3)</code> of committed seals as consensus proof in <code>extraData</code> to prove the block has gone through consensus.</li></ol> <p>The calculation is still similar to the <code>ethash</code> block hash calculation, with the exception that we need to deal with <code>extraData</code>. We calculate the fields as follows:</p> <h5 id="proposer-seal-calculation"><a href="#proposer-seal-calculation" aria-hidden="true" class="header-anchor">↳</a> Proposer seal calculation</h5> <p>By the time of proposer seal calculation, the committed seals are still unknown, so we calculate the seal with those unknowns empty. The calculation is as follows:</p> <ul><li><code>Proposer seal</code>: <code>SignECDSA(Keccak256(RLP(Header)), PrivateKey)</code></li> <li><code>PrivateKey</code>: Proposer's private key.</li> <li><code>Header</code>: Same as <code>ethash</code> header only with a different <code>extraData</code>.</li> <li><code>extraData</code>: <code>vanity | RLP(IstanbulExtra)</code>, where in the <code>IstanbulExtra</code>, <code>CommittedSeal</code> and <code>Seal</code> are empty arrays.</li></ul> <h5 id="block-hash-calculation"><a href="#block-hash-calculation" aria-hidden="true" class="header-anchor">↳</a> Block hash calculation</h5> <p>While calculating block hash, we need to exclude committed seals since that data is dynamic between different validators. Therefore, we make <code>CommittedSeal</code> an empty array while calculating the hash. The calculation is:</p> <ul><li><code>Header</code>: Same as <code>ethash</code> header only with a different <code>extraData</code>.</li> <li><code>extraData</code>: <code>vanity | RLP(IstanbulExtra)</code>, where in the <code>IstanbulExtra</code>, <code>CommittedSeal</code> is an empty array.</li></ul> <h5 id="consensus-proof"><a href="#consensus-proof" aria-hidden="true" class="header-anchor">↳</a> Consensus proof</h5> <p>Before inserting a block into the blockchain, each validator needs to collect <code>ceil(2N/3)</code> of committed seals from other validators to compose a consensus proof. Once it receives enough committed seals, it will fill the <code>CommittedSeal</code> in <code>IstanbulExtra</code>, recalculate the <code>extraData</code>, and then insert the block into the blockchain. <strong>Note</strong> that since committed seals can differ by different sources, we exclude that part while calculating the block hash as in the previous section.</p> <p>Committed seal calculation:</p> <p>Committed seal is calculated by each of the validators signing the hash along with <code>COMMIT_MSG_CODE</code> message code of its private key. The calculation is as follows:</p> <ul><li><code>Committed seal</code>: <code>SignECDSA(Keccak256(CONCAT(Hash, COMMIT_MSG_CODE)), PrivateKey)</code>.</li> <li><code>CONCAT(Hash, COMMIT_MSG_CODE)</code>: Concatenate block hash and <code>COMMIT_MSG_CODE</code> bytes.</li> <li><code>PrivateKey</code>: Signing validator's private key.</li></ul> <h2 id="provenance"><a href="#provenance" aria-hidden="true" class="header-anchor">↳</a> Provenance</h2> <p>Istanbul BFT implementation in Smilo is based on <a href="https://github.com/ethereum/EIPs/issues/650" target="_blank" rel="noopener noreferrer">EIP 650<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. It has been updated since the EIP was opened to resolve safety issues by introducing locking.</p></div></main> <div class="sidebar" data-v-586e078c><nav class="nav-links"><ul class="nav-ul"><li class="nav-item"><a href="/" class="nav-link">Smilo</a></li><li class="nav-item"><a href="/beginners/" class="nav-link">Beginners</a></li><li class="nav-item"><a href="/use/" class="nav-link">Use</a></li><li class="nav-item"><a href="/learn/" class="nav-link">Learn</a></li><li class="nav-item"><a href="/developers/" class="nav-link">Developers</a></li> <div class="dropdown-wrapper nav-item"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Consensus/sport/sport.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/ko/" class="nav-link">Korean</a></li></ul></div></ul></nav>  <!----> </div> <footer class="footer" data-v-ca550d00 data-v-586e078c><div class="credits" data-v-ca550d00>
    Artwork by <a href="https://impermanence.co" target="_blank" data-v-ca550d00>Lili Feyerabend</a> feat. <a href="https://ilankatin.com" target="_blank" data-v-ca550d00>ilan katin</a>, <a href="https://linktr.ee/mattiacprodukt" target="_blank" data-v-ca550d00>Mattia Cuttini</a>, <a href="https://oficinastk.github.io" target="_blank" data-v-ca550d00>Oficinas TK</a>, <a href="https://xcopyart.com" target="_blank" data-v-ca550d00>XCOPY</a>.
  </div> <ul data-v-ca550d00><li data-v-ca550d00><a href="https://github.com/smilofoundation" target="_blank" data-v-ca550d00>GitHub</a></li> <li data-v-ca550d00><a href="https://twitter.com/smiloplatform" target="_blank" data-v-ca550d00>Twitter</a></li> <li data-v-ca550d00><a href="https://blog.smilo.foundation/" data-v-ca550d00>Blog</a></li> <li data-v-ca550d00><a href="/privacy-policy/" data-v-ca550d00>Privacy Policy</a></li> <li data-v-ca550d00><a href="/terms-of-use/" data-v-ca550d00>Terms of Use</a></li> <li data-v-ca550d00><a href="/cookie-policy/" data-v-ca550d00>Cookie Policy</a></li> <li data-v-ca550d00><a href="mailto:info@smilo.foundation" data-v-ca550d00>Contact</a></li></ul></footer> <a href="https://hackernoon.com/rethinking-the-identity-of-ethereumorg-l718w347l" target="_blank" data-v-586e078c><button class="announcement" data-v-586e078c>
      Read about the new artwork! <span class="accent" data-v-586e078c>→  More</span></button></a></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1c5a03b7.js" defer></script><script src="/assets/js/3.030594d3.js" defer></script><script src="/assets/js/19.a08feb93.js" defer></script>
  </body>
</html>
